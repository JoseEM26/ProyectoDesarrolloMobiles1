<!-- src/app/components/dashboard/dashboard.component.html -->
<div class="dashboard-page">
  <!-- HEADER -->
  <header class="dashboard-header">
    <div class="header-content">
      <h1 class="dashboard-title">
        <i class="bi bi-speedometer2 me-2"></i>
        Panel de Control
      </h1>
      <p class="dashboard-subtitle">
        {{ user?.tipo === tipoUsuario.estudiante ? 'Tu rendimiento académico' :
           user?.tipo === tipoUsuario.profesor ? 'Gestión de tus asignaturas' :
           'Análisis institucional en tiempo real' }}
      </p>
    </div>
    <div class="header-actions">
      <button class="btn btn-refresh" (click)="refreshGrades()" [disabled]="isLoadingGrades">
        <i class="bi bi-arrow-clockwise" [class.spin]="isLoadingGrades"></i>
        Actualizar
      </button>
      <button *ngIf="user?.tipo === tipoUsuario.administrativo" class="btn btn-export ms-2" (click)="exportReport()" [disabled]="isExporting">
        <span class="spinner-border spinner-border-sm" *ngIf="isExporting"></span>
        <i class="bi bi-file-earmark-pdf-fill" *ngIf="!isExporting"></i>
        Exportar PDF
      </button>
    </div>
  </header>

  <!-- ESTADÍSTICAS -->
  <section class="stats-grid">
    <!-- Estudiantes (Admin) -->
    <div *ngIf="user?.tipo === tipoUsuario.administrativo" class="stat-card">
      <div class="stat-icon bg-primary">
        <i class="bi bi-people-fill"></i>
      </div>
      <div class="stat-body">
        <h3 class="stat-number">{{ studentsCount$ | async | number }}</h3>
        <p class="stat-label">Estudiantes Activos</p>
      </div>
      <div class="stat-trend up">+12%</div>
    </div>

    <!-- Asignaturas -->
    <div class="stat-card">
      <div class="stat-icon bg-success">
        <i class="bi bi-journal-text"></i>
      </div>
      <div class="stat-body">
        <h3 class="stat-number">{{ subjectsCount$ | async | number }}</h3>
        <p class="stat-label">Asignaturas</p>
      </div>
      <div class="stat-trend up">+5%</div>
    </div>

   <!-- Calificaciones -->
<div class="stat-card">
  <div class="stat-icon bg-accent">
<i class="bi bi-graph-up-arrow"></i>  </div>
  <div class="stat-body">
    <h3 class="stat-number">{{ gradesCount$ | async | number }}</h3>
    <p class="stat-label">Calificaciones</p>
  </div>
  <div class="stat-trend stable">Estable</div>
</div>

    <!-- Promedio -->
    <div class="stat-card">
      <div class="stat-icon bg-info">
        <i class="bi bi-graph-up-arrow"></i>
      </div>
      <div class="stat-body">
        <h3 class="stat-number">{{ overallAverage$ | async | number:'1.1-1' }}</h3>
        <p class="stat-label">{{ user?.tipo === tipoUsuario.estudiante ? 'Tu Promedio' : 'Promedio General' }}</p>
      </div>
      <div class="stat-trend up">+0.5</div>
    </div>
  </section>

  <!-- CALIFICACIONES RECIENTES -->
  <section class="section-card">
    <header class="section-header">
      <h2 class="section-title">
        <i class="bi bi-clock-history me-2"></i>
        {{ user?.tipo === tipoUsuario.estudiante ? 'Tus Calificaciones Recientes' :
           user?.tipo === tipoUsuario.profesor ? 'Calificaciones Recientes' :
           'Calificaciones del Sistema' }}
      </h2>
      <select [(ngModel)]="gradeFilter" (ngModelChange)="filterGrades()" class="form-select">
        <option value="all">Todas</option>
        <option value="recent">Más recientes</option>
        <option value="high">Mejores</option>
        <option value="low">Peores</option>
      </select>
    </header>

    <div class="section-body">
      <!-- Loading -->
      <div *ngIf="isLoadingGrades" class="text-center py-5">
        <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;"></div>
        <p class="mt-3 text-muted">Cargando...</p>
      </div>

      <!-- Empty -->
      <div *ngIf="!isLoadingGrades && !(filteredGrades$ | async)?.length" class="text-center py-5">
        <i class="bi bi-inbox display-1 text-muted opacity-50"></i>
        <p class="mt-3 text-muted">No hay calificaciones registradas</p>
      </div>

      <!-- Tabla -->
      <div class="table-responsive" *ngIf="(filteredGrades$ | async) as grades">
        <table class="grades-table">
          <thead>
            <tr>
              <th>Estudiante</th>
              <th>Asignatura</th>
              <th>Evaluación</th>
              <th class="text-center">Nota</th>
              <th class="text-end">Fecha</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let grade of grades">
              <td class="student-cell">
                <div class="d-flex align-items-center gap-3">
                  <div class="avatar rounded-circle" [style.background-color]="getAvatarColor(grade.estudianteId)">
                    <i [class]="getAvatarIcon(grade.estudianteId)" class="text-white"></i>
                  </div>
                  <div>
                    <div class="fw-semibold">{{ grade.estudianteNombre }}</div>
                    <small class="text-muted">{{ grade.estudianteId }}</small>
                  </div>
                </div>
              </td>
              <td>
                <span class="badge bg-primary bg-opacity-10 text-primary px-3 py-2 rounded-pill">
                  {{ grade.asignaturaNombre }}
                </span>
              </td>
              <td>{{ grade.evaluacion }}</td>
              <td class="text-center">
                <span class="grade-badge" [ngClass]="getGradeClass(grade.nota)">
                  {{ grade.nota | number:'1.1-1' }}
                </span>
              </td>
              <td class="text-end text-muted">
                {{ grade.fechaRegistroDate | date:'dd MMM yyyy' : 'es-ES' }}
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </section>

  <!-- HALL OF FAME -->
  <section class="section-card hall-of-fame">
    <header class="section-header">
      <h2 class="section-title">
        <i class="bi bi-trophy-fill me-2"></i>
        {{ user?.tipo === tipoUsuario.estudiante ? 'Tu Ranking' : 'Estrellas Académicas' }}
      </h2>
      <small class="text-muted">Promedio ≥ 17.0</small>
    </header>

    <div class="section-body p-4">
      <div *ngIf="!(topEliteStudents$ | async)?.length" class="text-center py-5">
        <i class="bi bi-star display-1 text-warning opacity-30"></i>
        <p class="mt-3 text-muted">No hay estudiantes destacados aún</p>
      </div>

      <div class="podium" *ngIf="topEliteStudents$ | async as students">
        <div class="podium-container">
          <div *ngFor="let s of students | slice:0:3; let i = index"
               class="podium-item"
               [ngClass]="'place-' + (i + 1)"
               [style.order]="i === 0 ? 2 : i === 1 ? 1 : 3">
            <div class="crown" *ngIf="i === 0">
              <i class="bi bi-crown-fill"></i>
            </div>
            <div class="rank">#{{ i + 1 }}</div>
            <div class="avatar-wrapper" [ngClass]="'winner-' + (i + 1)">
              <div class="avatar-bg"></div>
              <div class="avatar rounded-circle" [style.background-color]="getAvatarColor(s.estudianteId)">
                <i [class]="getAvatarIcon(s.estudianteId)" class="text-white"></i>
              </div>
            </div>
            <div class="name">{{ s.estudianteNombre }}</div>
            <div class="score" [ngClass]="'medal-' + (i + 1)">
              <i [class]="getMedalIcon(i)"></i>
              {{ s.average | number:'1.1-1' }}
            </div>
          </div>
        </div>

        <!-- Menciones Honoríficas -->
        <div class="honors mt-5" *ngIf="students.length > 3">
          <h4 class="text-center mb-4 text-muted">Menciones Honoríficas</h4>
          <div class="d-flex flex-wrap justify-content-center gap-3">
            <div *ngFor="let s of students | slice:3; let i = index" class="honor-item">
              <div class="rank">#{{ i + 4 }}</div>
              <div class="name">{{ s.estudianteNombre }}</div>
              <div class="score">{{ s.average | number:'1.1-1' }}</div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- GRÁFICOS -->
  <section class="charts-grid">
    <!-- Promedio por Asignatura -->
    <div class="chart-card">
      <div class="chart-header">
        <h3 class="chart-title">
          <i class="bi bi-bar-chart-line-fill me-2"></i>
          Promedio por Asignatura
        </h3>
      </div>
      <div class="chart-body">
        <canvas #averagesChart></canvas>
        <div *ngIf="!averageBySubject$ || !(averageBySubject$ | async)?.length" class="empty-state">
          <i class="bi bi-bar-chart-line display-1 text-muted"></i>
          <p>Sin datos</p>
        </div>
      </div>
    </div>

    <!-- Distribución -->
    <div class="chart-card">
      <div class="chart-header">
        <h3 class="chart-title">
          <i class="bi bi-pie-chart-fill me-2"></i>
          Distribución de Notas
        </h3>
      </div>
      <div class="chart-body">
        <canvas #gradesDistributionChart></canvas>
        <div *ngIf="!gradesDistribution$ || !(gradesDistribution$ | async)?.length" class="empty-state">
          <i class="bi bi-pie-chart display-1 text-muted"></i>
          <p>Sin datos</p>
        </div>
      </div>
    </div>

    <!-- Mensual -->
    <div class="chart-card">
      <div class="chart-header">
        <h3 class="chart-title">
          <i class="bi bi-calendar-month-fill me-2"></i>
          Notas por Mes
        </h3>
      </div>
      <div class="chart-body">
        <canvas #monthlyGradesChart></canvas>
        <div *ngIf="!monthlyGrades$ || !(monthlyGrades$ | async)?.length" class="empty-state">
          <i class="bi bi-calendar-x display-1 text-muted"></i>
          <p>Sin datos</p>
        </div>
      </div>
    </div>

    <!-- Más Difíciles -->
    <div *ngIf="user?.tipo !== tipoUsuario.estudiante" class="chart-card">
      <div class="chart-header">
        <h3 class="chart-title">
          <i class="bi bi-exclamation-triangle-fill me-2 text-danger"></i>
          Asignaturas Más Difíciles
        </h3>
      </div>
      <div class="chart-body">
        <canvas #hardestSubjectsChart></canvas>
        <div *ngIf="!hardestSubjects$ || !(hardestSubjects$ | async)?.length" class="empty-state">
          <i class="bi bi-patch-question display-1 text-muted"></i>
          <p>Sin datos</p>
        </div>
      </div>
    </div>
  </section>
</div>
